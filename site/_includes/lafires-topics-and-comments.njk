<script>

let current_topic_index = 19;
let current_filter = 'all';

document.addEventListener('DOMContentLoaded', function() {
  // Set up event handler for clicks on .findings-top-options-option-box
  document.querySelectorAll('.findings-top-options-option-box').forEach(function(box) {
    box.addEventListener('click', function() {
      // Remove 'active' from all option boxes
      document.querySelectorAll('.findings-top-options-option-box').forEach(function(el) {
        el.classList.remove('active');
      });
      document.querySelectorAll('.findings-top-discussion-container').forEach(function(el) {
        el.classList.remove('active');
      });
      // Add 'active' to the clicked box
      this.classList.add('active');
      // Add 'active' to the corresponding discussion container
      document.getElementById('findings-top-discussions-topic-' + this.dataset.topicNumber).classList.add('active');
      select_topic_chart(parseInt(this.dataset.chartTopicIndex, 10));
      current_topic_index = parseInt(this.dataset.chartTopicIndex, 10);
      populate_comments(current_topic_index, current_filter);
    });
  });

  let commentExpander = document.getElementById('findings-deliberation-comments-show-all-button');
  commentExpander.addEventListener('click', function() {
    console.log('Comment expander clicked');
    let container = document.getElementById('topics-deliberation-comments-container');
    let is_collapsed = container.classList.contains('collapsed');

    if (is_collapsed) {
      // populate it...
      populate_comments(current_topic_index, current_filter);
      container.classList.remove('collapsed');
    } else {
      container.classList.add('collapsed');
    }
  });

  document.querySelectorAll('.topics-alignment-switcher-item').forEach(function(item) {
    item.addEventListener('click', function() {
      // INSERT_YOUR_CODE
      document.querySelectorAll('.topics-alignment-switcher-item').forEach(function(el) {
        el.classList.remove('selected');
      });
      this.classList.add('selected');
      current_filter = this.dataset.filter;
      console.log("current_filter", current_filter);
      populate_comments(current_topic_index, current_filter);
    });
  });
});

function populate_comments(topic_index, filter) {
    let cmarkup = '';
    let chart_data = global_chart_data;
    // console.log("chart_data", chart_data);
    let fUserRecords = chart_data.user_recs.filter(rec => rec.tid == topic_index-1);
    if (filter == 'support') {
      fUserRecords = fUserRecords.filter(rec => rec.v >= 5);
    } else if (filter == 'neutral') {
      fUserRecords = fUserRecords.filter(rec => rec.v == 4);
    } else if (filter == 'oppose') {
      fUserRecords = fUserRecords.filter(rec => rec.v <= 3);
    }
    console.log("fUserRecords found:", fUserRecords.length);
    fUserRecords.forEach(rec => {
      let cid = rec.cid;
      if (cid >= 0 && cid < chart_data.comments.length) {
        let comment = chart_data.comments[cid];
        cmarkup += `<div class="deliberation-comment-item vote-${rec.v}"><div class="comment-fill">`;
        cmarkup += '“' + comment + '”';
        cmarkup += '</div></div>';
      }
    });
    let comment_container = document.getElementById('topics-deliberation-comments-container-content');  
    comment_container.innerHTML = cmarkup;
}

function legendItemHandler(e) {
  const legendItem = this;
  let is_collapsed = legendItem.classList.contains('collapsed');
  const expansionBlock = legendItem.querySelector('.legend-item-expansion-block');

  if (is_collapsed) {
    legendItem.classList.remove('collapsed');
    legendItem.setAttribute('aria-expanded', 'true');
    expansionBlock.setAttribute('aria-hidden', 'false');
  } else {
    legendItem.classList.add('collapsed');
    legendItem.setAttribute('aria-expanded', 'false');
    expansionBlock.setAttribute('aria-hidden', 'true');
  }
  is_collapsed = !is_collapsed;
  const nbrComments = legendItem.getAttribute('data-nbr-comments');
  const commentIds = legendItem.getAttribute('data-comment-ids');
  console.log('Legend item clicked:', nbrComments, commentIds);

  const legendItemContent = legendItem.querySelector('.legend-item-content');
  const parentElement = legendItemContent.parentElement;
  if (!is_collapsed) {
    let comment_list = '';
    const commentIdsArray = commentIds.split(',');
    for (let i = 0; i < nbrComments; i++) {
      comment_list += '<div class="deliberation-comment-item">';
      const cid = parseInt(commentIdsArray[i]);
      console.log("Looking up quote with comment id ", cid);
      const quote = quoteData.find(q => q.COMMENT_ID === cid);
      comment_list += '“' + quote.CONTENT + '”';
      comment_list += '</div>';
    }
    legendItemContent.innerHTML = comment_list;
    if (parentElement) {
      setLegendFade(parentElement, legendItemContent);
    }
  } else {
    legendItemContent.innerHTML = '';
  }
}


</script>
