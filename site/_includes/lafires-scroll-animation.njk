<script>

// Register GSAP plugin

gsap.registerPlugin(ScrollTrigger);

// Init Lenis
const lenis = new Lenis({
  duration: 1.2,
  easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t))
});

// Smooth scroll loop
function raf(time) {
  lenis.raf(time);
  requestAnimationFrame(raf);
}
requestAnimationFrame(raf); 

// Let ScrollTrigger work with Lenis, necessary to avoid positioning glitches, especially when scrolling back up
ScrollTrigger.scrollerProxy(document.body, {
  scrollTop(value) {
    return arguments.length ? lenis.scrollTo(value) : window.scrollY;
  },
  getBoundingClientRect() {
    return {
      top: 0,
      left: 0,
      width: window.innerWidth,
      height: window.innerHeight
    };
  },
  pinType: document.body.style.transform ? "transform" : "fixed"
});


// Let ScrollTrigger use native scroll position while Lenis handles visual smoothing
ScrollTrigger.refresh();

let topic_chart_setup = false;
let chart_data = null;

gsap.to({}, {
    scrollTrigger: {
      trigger: ".findings-narrative-step-1",
      start: "center center",
      end: "+=600", // scroll range for animation
      scrub: true,
      pin: true,
    }
  });
gsap.to({}, {
    scrollTrigger: {
      trigger: ".findings-narrative-step-2",
      start: "center center",
      end: "+=600", // scroll range for animation
      scrub: true,
      pin: true,
    }
  });
gsap.to({}, {
    scrollTrigger: {
      trigger: ".findings-narrative-step-3",
      start: "center center",
      end: "+=600", // scroll range for animation
      scrub: true,
      pin: true,
    }
  });
gsap.to({}, {
    scrollTrigger: {
      trigger: "#findings-narrative-top-options",
      start: "center center",
      end: "+=900", // scroll range for animation
      scrub: true,
      pin: true,
      onUpdate: (self) => {
        const t = self.progress; // 0 to 1
        if (consensus_vars.phase != 1) {
          consensus_chart_phase(1);
        }
      }
    }
  });

gsap.to({}, {
    scrollTrigger: {
      trigger: "#findings-consensus",
      start: "top bottom", // when bottom of trigger hits bottom of viewport
      end: "bottom top",         // extend the scroll range by 100vh
      scrub: 1, // Add a small delay to smooth out the progress updates
      pin: false,
      markers: false, // Enable markers for debugging
      onUpdate: (self) => {
        const t = self.progress; // 0 to 1
        // console.log("fcp-progress:", t);

        // At start (appears at bottom), set phase 1
        const canvas = document.getElementById('findings-consensus-sentiment-chart-dataviz-canvas');
        let opacity;
        if (t <= 0.4) {
          opacity = clamp(mapv(t, .2, 0.4, 0, 1), 0, 1);
        } else if (t > 0.6) {
          opacity = clamp(mapv(t, 0.6, 0.8, 1, 0), 0, 1);
        } else {
          opacity = 1;
        }
        if (canvas) {
          canvas.style.opacity = opacity;
        }

        if (t <= 0.01 && consensus_vars.phase !== 1) {
          consensus_chart_phase(1);
        }
        // At center (about halfway), set phase 2
        else if (t > 0.4 && t < 0.6 && consensus_vars.phase !== 2) {
          consensus_chart_phase(2);
        }
        // At end (exits top), set phase 3
        else if (t >= 0.6 && consensus_vars.phase !== 3) {
          consensus_chart_phase(3);
        }
      }
    }
  });


{# // discrete triggers
  gsap.to({}, {
    scrollTrigger: {
      trigger: "#findings-consensus",
      start: "top bottom",
      end: "+=0", // scroll range for animation
      scrub: true,
      pin: true,
      onUpdate: (self) => {
        const t = self.progress; // 0 to 1
        if (consensus_vars.phase != 1) {
          consensus_chart_phase(1);
        }
      }
    }
  });

gsap.to({}, {
    scrollTrigger: {
      trigger: "#findings-consensus",
      start: "top center",
      end: "+=0", // scroll range for animation
      scrub: true,
      pin: true,
      onUpdate: (self) => {
        const t = self.progress; // 0 to 1
        if (consensus_vars.phase != 2) {
          consensus_chart_phase(2);
        }
      }
    }
  });

gsap.to({}, {
    scrollTrigger: {
      trigger: "#findings-consensus",
      start: "bottom top",
      end: "+=0", // scroll range for animation
      scrub: true,
      pin: true,
      onUpdate: (self) => {
        const t = self.progress; // 0 to 1
        if (consensus_vars.phase != 3) {
          consensus_chart_phase(3);
        }
      }
    }
  }); #}




{# 
gsap.to({}, {
    scrollTrigger: {
      trigger: "#consensus-chart-outro-trigger",
      start: "center center",
      end: "+=0", // scroll range for animation
      scrub: true,
      pin: true,
      onUpdate: (self) => {
        const t = self.progress; // 0 to 1
        if (consensus_vars.phase != 3) {
          consensus_chart_phase(3);
        }
      }
    }
  }); #}

gsap.to({}, {
    scrollTrigger: {
      trigger: "#findings-top-topics-dataviz-container",
      start: "top center",
      end: "+=0", // scroll range for animation
      scrub: true,
      pin: true,
      onUpdate: (self) => {
        const t = self.progress; // 0 to 1
        if (topic_vars.phase != 2) {
          topic_chart_phase(2);
        }
      }
    }
  });

</script>