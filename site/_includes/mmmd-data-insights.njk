{% extends "layout.njk" %}
{% block content %}
<style>
.quote-card {
  background-color: #f0f0f0;
  padding: 10px;
  border-radius: 5px;
  max-width: 500px;
  {# margin: 0 auto; #}
}
.plot-row {
  position: relative;
}
.quote-card {
  position: fixed;
  width: 100%;
  opacity: 0.8;
  z-index: 1000;
}
.responsive-svg-container svg {
  width: 100%;
  height: auto;
  max-width: 100%;
}
</style>
<section id="plots-overview">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        {{ modules.plots_overview.content | safe }}
      </div>
    </div>
  </div>
</section>

<div class="quote-card" style="display: none;">
  <div class="quote-card-content">
  </div>
</div>


<section id="plot-1">
  <div class="container">
    <div class="row plot-row">
      <div class="col-lg-12 responsive-svg-container">
            {{ ('./src/public/images/' + modules.plots.plot_1) | getFileContents | safe }}
      </div>
    </div>
  </div>
</section>

<section id="plot-2">
  <div class="container">
    <div class="row plot-row">
      <div class="col-lg-12 responsive-svg-container">
            {{ ('./src/public/images/' + modules.plots.plot_2) | getFileContents | safe }}
      </div>
    </div>
  </div>
</section>

<section id="plot-3">
  <div class="container">
    <div class="row plot-row">
      <div class="col-lg-12 responsive-svg-container">
            {{ ('./src/public/images/' + modules.plots.plot_3) | getFileContents | safe }}
      </div>
    </div>
  </div>
</section>

<section id="plot-4">
  <div class="container">
    <div class="row plot-row">
      <div class="col-lg-12 responsive-svg-container">
            {{ ('./src/public/images/' + modules.plots.plot_4) | getFileContents | safe }}
      </div>
    </div>
  </div>
</section>

<section id="plot-5">
  <div class="container">
    <div class="row plot-row">
      <div class="col-lg-12 responsive-svg-container">
            {{ ('./src/public/images/' + modules.plots.plot_5) | getFileContents | safe }}
      </div>
    </div>
  </div>
</section>



<script>
quoteData = null;

function revealQuote(cid, evt) {
  const mouseX = evt.clientX;
  const mouseY = evt.clientY;
  if (quoteData == null) {
    console.log('No quote data found');
    return;
  }
  const quote = quoteData.find(q => q.COMMENT_ID === cid);
  if (quote) {
    document.querySelector('.quote-card-content').innerHTML = quote.CONTENT;
  } else {
    console.log('No quote found for comment_id:', cid);
  }
  const quote_left = mouseX > window.innerWidth / 2 ? '10%' : '50%';
  const quote_top = mouseY > window.innerHeight / 2 ? '10%' : '50%';

  // Position the quote card 20px to the right and 200px above the cursor
  const quoteCard = document.querySelector('.quote-card');
  quoteCard.style.left = (mouseX + 20) + 'px';
  quoteCard.style.top = (mouseY - 100) + 'px';
  
  // Clear any previously set positioning styles that might interfere
  quoteCard.style.right = 'auto';
  quoteCard.style.bottom = 'auto';


  {# if (mouseX > window.innerWidth / 2) {
    // clear left, and set right to window.innerWidth/2
    document.querySelector('.quote-card').style.left = 'inherit';
    document.querySelector('.quote-card').style.right = '50%';
  } else {
    // clear right and set left to window.innerWidth/2
    document.querySelector('.quote-card').style.left = '50%';
    document.querySelector('.quote-card').style.right = 'inherit';
  }
  if (mouseY > window.innerHeight / 2) {
    // clear top, and set bottom to window.innerHeight/2
    document.querySelector('.quote-card').style.top = 'inherit';
    document.querySelector('.quote-card').style.bottom = '50%';
  } else {
    // clear bottom and set top to window.innerHeight/2
    document.querySelector('.quote-card').style.top = '50%';
    document.querySelector('.quote-card').style.bottom = 'inherit';
  } #}
  document.querySelector('.quote-card').style.display = 'block';
}

function hideQuote() {
  document.querySelector('.quote-card-content').innerHTML = '';
  document.querySelector('.quote-card').style.display = 'none';
}


document.addEventListener('DOMContentLoaded', function() {
    fetch("/public/data/engca_comment_scatterplot_source.json", {})
    .then(response => response.json())
    .then(data => {
      // console.log("Data fetched:", data);
      quoteData = data;
    })
    .catch(error => {
      console.error("Error fetching data:", error);
    });

 
  // Direct access to SVG elements since they're now in the DOM
  const datapoints = document.querySelectorAll('.datapoint');
  // console.log("Found datapoints:", datapoints.length);
  
  // Set up event handlers for datapoints in plots
  datapoints.forEach(datapoint => {
    // Add hover effect
    datapoint.addEventListener('mouseenter', function(e) {
      this.setAttribute('r', '8'); // Increase radius on hover
      this.style.cursor = 'pointer';
      const comment_id = parseInt(this.getAttribute('data-cid'));
      if (isNaN(comment_id)) {
        console.log('Datapoint clicked with invalid comment_id:', this.getAttribute('data-cid'));
        return;
      }
      revealQuote(comment_id, e);
    });
    
    datapoint.addEventListener('mouseleave', function() {
      this.setAttribute('r', '5'); // Reset radius when not hovering
      hideQuote();
    });
    
    // Add click handler
    datapoint.addEventListener('click', function(e) {
      const comment_id = parseInt(this.getAttribute('data-cid'));
      // if not a valid integer when converted to int, return early
      if (quoteData == null) {
        console.log('No quote data found');
        return;
      }
      if (isNaN(comment_id)) {
        console.log('Datapoint clicked with invalid comment_id:', this.getAttribute('data-cid'));
        return;
      }
      revealQuote(comment_id, e);
      // console.log('Datapoint clicked:', comment_id);
      // You can add more functionality here, like showing details about the point
    });
  });
});
</script>

{% endblock %}