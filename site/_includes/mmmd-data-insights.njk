{% extends "layout.njk" %}
{% block content %}
<style>
.quote-card {
  background-color: #f0f0f0;
  padding: 10px;
  border-radius: 5px;
  max-width: 500px;
  {# margin: 0 auto; #}
  font-size: 1rem;
}
.plot-row {
  position: relative;
}
.quote-card {
  position: fixed;
  width: 100%;
  opacity: 0.8;
  z-index: 1000;
}
.responsive-svg-container svg {
  width: 100%;
  height: auto;
  max-width: 100%;
  position: relative;
}
.plot-title {
  font-size: 1.5rem;
  font-weight: 600;
  font-family: "Noto Sans Display" !important;
  text-align: left;
  {# max-width: 50%; #}
  {# position: absolute;
  top: 0px;
  left: 50px; #}
}
div.plot-legend {
  margin-top: 20px;
}
section.plot-section {
    padding-top: 0;
}
section#data-visualizations {
    padding-bottom: 0;
}
@media (orientation: landscape) {
  .responsive-svg-container {
    display: flex;
    flex-wrap: wrap;
  }
  
  .plot-title {
    width: 100%;
  }
  
  .plot-plot {
    width: 65%;
  }
  
  div.plot-legend {
    width: 35%;
    margin-top: 0;
    padding-left: 10px;
  }
}

</style>
<section id="plots-overview">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        {{ modules.plots_overview.content | safe }}
      </div>
    </div>
    <a href="#" data-appearance="button" data-theme="orange">
      {{ modules.plots_overview.buttonText }}
    </a> 
  </div>
</section>

<section id="plots-interpretation">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        {{ modules.plots_interpretation.content | safe }}
      </div>
    </div>
  </div>
</section>

<section id="data-visualizations">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        {{ modules.data_visualizations_header.content | safe }}
      </div>
    </div>
  </div>
</section>


<div class="quote-card" style="display: none;">
  <div class="quote-card-content">
  </div>
</div>


{% for i in range(1, 6) %}
<section id="plot-{{ i }}" class="plot-section">
  <div class="container">
    <div class="row plot-row">
      <div class="col-lg-12 responsive-svg-container">
            <div class="plot-title">
              {{ modules.plots["title_" + i] }}
            </div>
            <div class="plot-plot">
            {{ ('./src/public/images/' + modules.plots["plot_" + i]) | getFileContents | safe }}
            </div>
            <div class="plot-legend">
              {{ ('./src/public/images/' + modules.plots["legend_" + i]) | getFileContents | safe }}
            </div>
      </div>
    </div>
  </div>
</section>
{% endfor %}


<section id="how-we-built">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        {{ modules.how_we_built.content | safe }}
      </div>
    </div>
  </div>
</section>

<section id="download-the-data">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">

        {{ modules.download_the_data_1.content | safe }}

        <a href="#" data-appearance="button" data-theme="orange">
          {{ modules.download_the_data_1.buttonText }}
        </a> 
<br/><br/>
        {{ modules.download_the_data_2.content | safe }}

      </div>
    </div>
  </div>
</section>


<script>
quoteData = null;

function revealQuote(cid, evt, is_touch) {
  const mouseX = evt.clientX;
  const mouseY = evt.clientY;
  if (quoteData == null) {
    console.log('No quote data found');
    return;
  }
  const quote = quoteData.find(q => q.COMMENT_ID === cid);
  if (quote) {
    document.querySelector('.quote-card-content').innerHTML = quote.CONTENT;
  } else {
    console.log('No quote found for comment_id:', cid);
  }

  // This compensates for current zoom level to make the quote more readable if you are zoomed in or zoomed out
  // which helps for mobile devices.
  const desiredFontSize = 1;
  const devicePixelRatio = window.devicePixelRatio || 1;
  const actualZoom = (( window.outerWidth - 10 ) / window.innerWidth);
   
  // For Retina displays, we might want a slightly larger base size
  console.log('Actual zoom:', actualZoom);
   
  // Adjust for browser zoom (higher zoom should make font smaller)
  const quoteCard = document.querySelector('.quote-card');
  quoteCard.style.fontSize = `${desiredFontSize / actualZoom}rem`;
  quoteCard.style.maxWidth = `${500 / actualZoom}px`;

  // Position the quote card 20px to the right and 200px above the cursor
  if (is_touch) {
    quoteCard.style.left = '0px';
    quoteCard.style.top = (mouseY + 20/actualZoom) + 'px';
  } else {
    quoteCard.style.left = (mouseX + 20/actualZoom) + 'px';
    quoteCard.style.top = (mouseY - 100/actualZoom) + 'px';
  }
  
  // Clear any previously set positioning styles that might interfere
  quoteCard.style.right = 'auto';
  quoteCard.style.bottom = 'auto';


  document.querySelector('.quote-card').style.display = 'block';
}

function hideQuote() {
  document.querySelector('.quote-card-content').innerHTML = '';
  document.querySelector('.quote-card').style.display = 'none';
}


document.addEventListener('DOMContentLoaded', function() {
    fetch("/public/data/engca_comment_scatterplot_source.json", {})
    .then(response => response.json())
    .then(data => {
      // console.log("Data fetched:", data);
      quoteData = data;
    })
    .catch(error => {
      console.error("Error fetching data:", error);
    });

 
  // Direct access to SVG elements since they're now in the DOM
  const datapoints = document.querySelectorAll('.datapoint');
  // console.log("Found datapoints:", datapoints.length);

  let expandHandler = function(e) {
    this.querySelector('.visible').setAttribute('r', '8'); // Increase radius on hover
    this.style.cursor = 'pointer';
    const comment_id = parseInt(this.getAttribute('data-cid'));
    if (isNaN(comment_id)) {
      console.log('Datapoint clicked with invalid comment_id:', this.getAttribute('data-cid'));
    }
    revealQuote(comment_id, e, false);
  }
  let shrinkHandler = function(e) {
    this.querySelector('.visible').setAttribute('r', ''); // Increase radius on hover
    hideQuote();
  }

  // Set up event handlers for datapoints in plots
  datapoints.forEach(datapoint => {
    // Add hover effect
    datapoint.addEventListener('mouseenter', expandHandler);
    
    datapoint.addEventListener('touchstart', expandHandler);
    
    datapoint.addEventListener('mouseleave', shrinkHandler);
    
    datapoint.addEventListener('touchend', shrinkHandler);
    
    // Add click handler
    {# datapoint.addEventListener('click', function(e) {
      const comment_id = parseInt(this.getAttribute('data-cid'));
      // if not a valid integer when converted to int, return early
      if (quoteData == null) {
        console.log('No quote data found');
        return;
      }
      if (isNaN(comment_id)) {
        console.log('Datapoint clicked with invalid comment_id:', this.getAttribute('data-cid'));
        return;
      }
      revealQuote(comment_id, e, false);
      // console.log('Datapoint clicked:', comment_id);
      // You can add more functionality here, like showing details about the point
    }); #}
  });
});
</script>

{% endblock %}